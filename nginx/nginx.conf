worker_processes 1;

events {
    worker_connections 1024;
}

http {
    server {
        listen 8080;

        resolver 8.8.8.8 ipv6=off;

        location / {
            proxy_pass $scheme://$http_host$request_uri;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            access_by_lua_block {
                local cjson = require "cjson.safe"
                ngx.req.read_body()
                local body = ngx.req.get_body_data() or ""

                local request_json
                local ok, parsed = pcall(cjson.decode, body)
                if ok and parsed then
                    request_json = parsed
                else
                    request_json = body
                end
                ngx.ctx.request_json = request_json
            }

            body_filter_by_lua_block {
                local cjson = require "cjson.safe"
                local chunk = ngx.arg[1]
                ngx.ctx.buffered = (ngx.ctx.buffered or "") .. (chunk or "")

                if ngx.arg[2] then
                    local resp_body = ngx.ctx.buffered
                    local response_json
                    local ok, parsed = pcall(cjson.decode, resp_body)
                    if ok and parsed then
                        response_json = parsed
                    else
                        response_json = resp_body
                    end

                    local log_record = {
                        timestamp      = ngx.localtime(),
                        remote_addr    = ngx.var.remote_addr,
                        method         = ngx.var.request_method,
                        uri            = ngx.var.request_uri,
                        status         = ngx.status,
                        request_headers= ngx.var.http_user_agent,
                        request_body   = ngx.ctx.request_json,
                        response_body  = response_json,
                        log_type       = "nginx-proxy"
                    }

                    -- write JSON directly to a file that Fluent Bit tails
                    local log_file = io.open("/var/log/nginx/proxy.log", "a+")
                    if log_file then
                        log_file:write(cjson.encode(log_record) .. "\n")
                        log_file:close()
                    end
                end
            }
        }
    }
}